{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>bld | 서울시립대 음식점</title>
  <link rel="stylesheet" type="text/css" href="{% static 'base_app/css/base.css' %}">
  <link href="https://fonts.googleapis.com/css?family=Nanum+Gothic" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="{% static 'base_app/css/swiper.min.css' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
</head>
<body>

<!-- Swiper -->
<div class="swiper-container">
  <div class="swiper-wrapper">
    <div class="swiper-slide menu">

          <!--plus-->
      <div style="display: none;" class="black_block3"></div>
      <div id="plus"><img src="{% static 'base_app/images/plus.png' %}" width="50"></div>
      <div class="plus plus1">
        <a href="#"><img src="{% static 'base_app/images/write.png' %}" width="50"></a>
      </div>
      <div class="plus plus1 message1">후기 작성</div>
      <div class="plus plus2">
        <img src="{% static 'base_app/images/police.png' %}" width="50">
      </div>
      <div class="plus plus2 message2">신고(예정)</div>


      <div class="content_head">
        <div class="head_left">
          <div class="main_menu"><img src="{% static 'base_app/images/menu.png' %}" height="25"></div>
{#          {% block main_title %}#}
{#            <div class="main_title">식당</div>#}
{#          {% endblock %}#}
        </div>
        <div class="head_right">
          {% block head_right4 %}
          <div class="all_comments" id="head_right4">
            <a href="{% url "base_app:all_comments" %}">
              <img src="{% static 'base_app/images/comments.png' %}" height="25">
            </a>
          </div>
          {% endblock %}
          {% block head_right23 %}
          <div class="map" id="head_right3">
            <img src="{% static 'base_app/images/map.png' %}" height="25">
          </div>
          <div class="filter" id="head_right2">
            <img src="{% static 'base_app/images/filter.png' %}" height="22">
          </div>
          {% endblock %}
          {% block head_right1 %}
          <div class="search" id="head_right1">
            <img src="{% static 'base_app/images/searching.png' %}" height="23">
          </div>
          {% endblock %}
        </div>
        <div style="display: none" class="search_input">
          <form method="get" action="" id="search_submit">
            {% block search %}
            <input class="search_text" type="text" name="search" placeholder="(식당) 검색어를 입력해주세요" required>
            {% endblock %}
          </form>
        </div>
      </div>
      <div style="display: none" class="black_block"></div>
      <div style="display: none" class="main_menu_bar">
        <div class="logo"><img src="{% static 'base_app/images/logo.png' %}" width="100"></div>
        <div class="notice">
          <div>ver 1.0</div>
          <div>공지(예정)</div>
        </div>
        <div class="log">
          {% if not user.is_authenticated %}
            <div><a href="{% url "accounts:login" %}">로그인</a></div>
            <div>회원가입</div>
          {% else %}
            <div>
              <form id="logout" action="{% url "accounts:logout" %}" method="POST">
                {% csrf_token %}
                <div class="logout">로그아웃</div>
              </form>
            </div>
            <div>먹킷리스트(예정)</div>
          {% endif %}
        </div>
      </div>
      <div style="display: none" class="white_block"></div>

      <!--mid-->
      <div class="content_mid">
        <div class="main_page">
            <!--filter-->
          <div style="display: none" class="filter_page">
            <form method="get" action="" id="filter_submit">
              <div class="filter_sort">
                <div class="filter_sort_title">정렬</div>
                <div class="filter_sort_content">
                  <div class="sort" id="sort1">평점순</div>
                  <div class="sort" id="sort2">인기순</div>
                  <div class="sort" id="sort3">등록순</div>
                </div>
              </div>
              <div class="filter_category">
                <div class="filter_category_title">종류</div>
                <div class="filter_category_content">
                  {% for category in categorys %}
                    <div class="category" id="category{{ category.pk }}">
                      <div>{{ category }}</div>
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div id="filter_submit_btn">필터 적용</div>
              <input type="hidden" id="value1" name="sort">
              <input type="hidden" id="value2" name="category">
            </form>
          </div>
          <div style="display: none" class="black_block2"></div>

            <!--restaurants-->
          {% block content %}
          <div class="content_list restaurants">
            {% for restaurant in restaurants %}
              <div class="restaurant_set {{ restaurant.category }}">
                <div style="height: 60px; width: 60px; background-color: #9dc9ec" class="restaurant_image"></div>
                <div class="restaurant_content">
                  <div class="restaurant_content_left">
                    <div class="restaurant_name">{{ restaurant.number }}. {{ restaurant }}</div>
                    <div class="restaurant_info">010-0000-0000<br>0요일 오후 0시 ~ 오후 0시</div>
                    <div class="restaurant_star">
                      <b>{{ restaurant.average_star }}</b><span class="comment_count"> {{ restaurant.comment_count }}</span>
                      <span>맛 {{ restaurant.taste_star }}  가격 {{ restaurant.price_star }}  청결 {{ restaurant.clean_star }}</span>
                    </div>
                  </div>
                  <div class="restaurant_content_right">
                    <div><span>혼밥 </span><span>{% if restaurant.is_eating_lonely_possible %}{{ restaurant.is_eating_lonely_possible }}{% else %}-{% endif %}</span></div>
                    <div><span>포장 </span><span>{% if restaurant.is_package_possible %}{{ restaurant.is_package_possible }}{% else %}-{% endif %}</span></div>
                    <div><span>배달 </span><span>{% if restaurant.is_delivery_possible %}{{ restaurant.is_delivery_possible }}{% else %}-{% endif %}</span></div>
                  </div>
                </div>
                <a href="{% url "base_app:restaurant" pk=restaurant.pk %}"><div class="comments">후<br>기<br>보<br>기</div></a>
              </div>
            {% endfor %}
          </div>
          {% endblock %}
        </div>
      </div>
    </div>

    <div class="swiper-slide content">
      <div class="map">
        <!--map-->
        <div id="map"></div>
      </div>
      <div style="display: none" class="menu-button cross">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </div>
    </div>
  </div>
</div>

  <!--jquery-->
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

  <!-- Swiper JS -->
{#<script src='../../static/base_app/js/swiper.min.js'></script>#}
<script src="{% static 'base_app/js/swiper.min.js' %}"></script>

<!-- Initialize Swiper -->
<script>
  var menuButton = document.querySelector('.menu-button');
  var map = document.querySelector('.map');
  var swiper = new Swiper('.swiper-container', {
    slidesPerView: 'auto',
    initialSlide: 0,
    resistanceRatio: 0,
    slideToClickedSlide: false,
    allowTouchMove: false,
    on: {
      init: function () {
        var slider = this;
        menuButton.addEventListener('click', function () {
          if (slider.activeIndex === 0) {
            slider.slideNext();
          } else {
            slider.slidePrev();
            $('.menu-button').hide();
            $('#map').css('width', 'calc(100% - 320px)')
          }
        }, true);

        map.addEventListener('click', function () {
          if (slider.activeIndex === 0) {
            slider.slideNext();
            $('.menu-button').show();
            $('#map').css('width', '100%')
          } else {
            slider.slidePrev();
          }
        }, true);
      },
      slideChange: function () {
        var slider = this;
        if (slider.activeIndex === 0) {
          menuButton.classList.add('cross');
        } else {
          menuButton.classList.remove('cross');
        }
      },
    },
  });
</script>

{% block mapMarker %}
  <!--map setting -->
  <script>
    var markers = [];
    var markerCluster= null;
    // TODO: category 해당 restaurant 추출
    function initMap() {
// map options
            var options = {
                center: {lat: 37.583929, lng: 127.059024},
                zoom: 14,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                maxZoom: 21,
            };

            // new map
            var map = new
            google.maps.Map(document.getElementById('map'), options);
            {% for restaurant in restaurants %}
                {#if (markers.length <= 9 | map.getCameraPosition >= 16) {#}
                    var marker = new google.maps.Marker({
                        position: {{ restaurant.locate }},
                        label: {
                            text: "{{ restaurant.number }}",
                            color: 'white',
                        },
                        map: map,
                    });

                    // 클릭 시 restaurant 소개 & 센터 오게
                    var restaurant_introduction =
                        '<div style="width: 250px; border-bottom: none; margin-bottom: 8px; margin-top: 16px; margin-right: 10px;" class="restaurant_set">\n' +
                        ' <div style="height: 60px; width: 60px; background-color: #9dc9ec" class="restaurant_image"></div>\n' +
                        ' <div class="restaurant_content">\n' +
                        '   <div class="restaurant_content_left">\n' +
                        '     <div class="restaurant_name"><b>{{ restaurant }}</b></div>\n' +
                        '     <div class="restaurant_info">010-0000-0000<br>0요일 오후 0시 ~ 오후 0시</div>\n' +
                        '     <div class="restaurant_star">\n' +
                        '       <b>{{ restaurant.average_star }}</b><span class="comment_count"> {{ restaurant.comment_count }}</span>\n' +
                        '       <span>맛 {{ restaurant.taste_star }}  가격 {{ restaurant.price_star }}  청결 {{ restaurant.clean_star }}</span>\n' +
                        '     </div>\n' +
                        '   </div>\n' +
                        '   <div class="restaurant_content_right">\n' +
                        '     <div><span>혼밥 </span><span>{% if restaurant.is_eating_lonely_possible %}{{ restaurant.is_eating_lonely_possible }}{% else %}-{% endif %}</span></div>\n' +
                        '     <div><span>포장 </span><span>{% if restaurant.is_package_possible %}{{ restaurant.is_package_possible }}{% else %}-{% endif %}</span></div>\n' +
                        '     <div><span>배달 </span><span>{% if restaurant.is_delivery_possible %}{{ restaurant.is_delivery_possible }}{% else %}-{% endif %}</span></div>\n' +
                        '   </div>\n' +
                        ' </div>\n' +
                        ' <a href="{% url "base_app:restaurant" pk=restaurant.pk %}"><div class="comments">후<br>기<br>보<br>기</div></a>\n' +
                        '</div>\n';

                    marker['infowindow'] = new google.maps.InfoWindow({
                        content: restaurant_introduction,
                    });

                    marker.addListener('click', function() {
                        map.setZoom(19);
                        map.panTo(this.getPosition());
                        this['infowindow'].open(map, this);
                    });

                    markers.push(marker);
                    if (markers.length > 10) {
                        marker.setVisible(false);
                    }
                {# }#}
            {% endfor %}

            /* Change markers on zoom */
            google.maps.event.addListener(map, 'zoom_changed', function() {
                var zoom = map.getZoom();
                var len = markers.length;
                function hideShow(len, x) {
                    if (len >= x) {
                        for (i = x; i < len; i++) {
                            markers[i].setVisible(false);
                        }
                        for (i = 0; i < x; i++) {
                            markers[i].setVisible();
                        }
                    }
                }
                // iterate over markers and call setVisible
                if (zoom >= 19) {
                    for (i = 0; i < len; i++) {
                        markers[i].setVisible();
                    }
                } else if (zoom >= 18) {
                    hideShow(len, 30)
                } else if (zoom >= 17) {
                    hideShow(len, 20)
                } else if (zoom >= 16) {
                    hideShow(len, 15)
                } else if (zoom >= 14) {
                    hideShow(len, 10)
                } else {
                    hideShow(len, 5)
                }
            });
            {#var markerCluster = new MarkerClusterer(map, markers,#}
            {#    {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});#}
    }


  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbX8bL78zKMX1D7viqLsXJikPwaLB8omQ&callback=initMap"
  async defer></script>
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
  </script>
{% endblock %}



<script>
  // plus 버튼 클릭 시
var plusButton = $('#plus');
var blackBlack3 = $('.black_block3');
var plusGroup = $('.plus');

plusButton.on('click', function () {
    if (plusButton.css('z-index') === '6') {
        plusDefault()
    } else if (plusButton.css('-webkit-transform') !== 'rotate(45deg)') {
        plusButton.css('-webkit-transform', 'rotate(45deg)');
        plusButton.css('-webkit-transition', '-webkit-transform 1s');
        plusButton.children('img').css('box-shadow', 'none');
        plusGroup.fadeIn(800);
        plusButton.css('z-index', '6');
        blackBlack3.fadeIn(800);
    }
});
blackBlack3.on('click', function () {
  plusDefault()
 });

function plusDefault () {
    plusButton.css('-webkit-transform', 'rotate(0deg)');
    plusButton.css('-webkit-transition', '-webkit-transform 1s');
    plusButton.children('img').css('box-shadow', '#999 0 3px 6px');
    blackBlack3.hide();
    plusGroup.hide();
    plusButton.css('z-index', '1');
}


  // 메뉴 클릭시
var menu = $('.main_menu');
var menuBar = $('.main_menu_bar');
var blackBlock = $('.black_block');
var logo = $('.logo');

menu.on('click', function () {
    menuBar.show();
    blackBlock.show();
});
logo.on('click', menuHide);
blackBlock.on('click', menuHide);
function menuHide() {
    menuBar.hide();
    blackBlock.hide();
}

  // logout 클릭 시
$('.logout').on('click', function () {
    $('#logout').submit();
});

  // filter 버튼 클릭 시
var filterButton = $('.filter');
var filterPage = $('.filter_page');
var blackBlock2 = $('.black_block2');
var sort = $('.sort');
var category = $('.category');

filterButton.on('click', function () {
    if (filterPage.css('display') === 'none') {
        filterPage.fadeIn(500);
        blackBlock2.fadeIn(500);
    } else {
        filterPage.fadeOut(500);
        blackBlock2.fadeOut(500);
    }
});
blackBlock2.on('click', function () {
    filterPage.fadeOut(500);
    blackBlock2.fadeOut(500);
});

 // filter 분류 작업
var sortHtml = "";
var categoryHtml = "";
var categoryHtmls = [];

sort.on('click', function () {
    var a=0;
    for (i=0; i<3; i++) {
        if (sort[i].classList[1] === 'sort_selected') {
            a=1;
        }
    }
    if (a === 0) {
        sortSelected($(this));
        sortHtml = $(this).html()
    } else {
        sortUnselected(sort);
        sortSelected($(this));
        sortHtml = $(this).html()
    }
});
function sortSelected(x) {
    x.addClass('sort_selected')
}
function sortUnselected(x) {
    x.removeClass('sort_selected')
}

category.on('click', function () {
    if ('category_selected' !== this.classList[1]) {
        categorySelected($(this));
        categoryHtml = $(this)[0].innerText;
        categoryHtmls.push(categoryHtml);
    } else {
        categoryUnselected($(this));
        categoryHtml = $(this)[0].innerText;
        var index = categoryHtmls.indexOf(categoryHtml);
        categoryHtmls.splice(index, 1);
    }
});

function categorySelected(x) {
    x.addClass('category_selected')
}
function categoryUnselected(x) {
    x.removeClass('category_selected')
}

 // filter 값 submit
$('#filter_submit_btn').on('click', function () {
    if (sortHtml) {
        if (categoryHtml) {
            $('#value1').val(sortHtml);
            $('#value2').val(categoryHtmls);
            $('#filter_submit').submit();
        }
    }
});


  // search 버튼 클릭 시
var search = $('.search');
var searchBox = $('.search_input');
var searchText = $('.search_text');
var whiteBlock = $('.white_block');

search.on('click', function () {
    filterPage.hide();
    blackBlock2.hide();
    searchBox.fadeIn(500);
    whiteBlock.fadeIn(500);
    search.on('click', function () {
        if (searchText.val()) {
            $("#search_submit").submit();
        }
    });
});
whiteBlock.on('click', function () {
    searchBox.fadeOut(500);
    whiteBlock.fadeOut(500);
    searchText.val('')
});


  // scroll 시 plus 버튼 일시적으로 없애기
$('.comment_list').on('touchmove', hideScroll);
$('.restaurants').on('touchmove', hideScroll);
$('.comment_list').on('scroll', hideScroll);
$('.restaurants').on('scroll', hideScroll);

function hideScroll() {
    $('#plus').hide().fadeIn(1500)
}

</script>
</body>
</html>